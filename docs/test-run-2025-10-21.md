# Test Run â€” 2025-10-21

This run executed the requested validations sequentially and captured outcomes.

## 1) Validate DB RLS via Docker

- Command: `bash scripts/test-rls-docker.sh`
- Result: All migrations applied and all SQL RLS tests passed.

## 2) Auth/MFA Unit Tests

- Command:
  `./node_modules/.bin/tsx --test tests/integration/authx-security.test.ts`
- Result: 4/4 passing.

## 3) PWA Verification

- Command: `npm run verify:pwa`
- Checks: manifest icons (192/512), root layout metadata, service worker
  presence, production build, `/api/health` probe.
- Result: All checks passed. Health endpoint responded OK.

## 4) Lint and Typecheck

- Command: `npm run lint && npm run typecheck`
- Result: No lint or TypeScript errors.

## 5) Dev Server Smoke

- Added script `scripts/dev-healthcheck.mjs` to spawn `next dev` on port 3200
  and probe key routes.
- Command: `node scripts/dev-healthcheck.mjs`
- Result: `GET /api/health`, `GET /login`, and `GET /` returned OK.

## 6) E2E (Playwright)

- Command: `npm run test:e2e`
- Initial state: Missing `/api/__e2e/factors/verify` caused MFA tests to 404.
  Implemented E2E-only endpoints and re-ran.
- Final Result: 5 passed, 2 failed.

### Passing

- MFA factor facade (invalid TOTP rejected)
- MFA factor facade (valid TOTP accepted)
- MFA factor facade (TOTP replay blocked)
- MFA factor facade (backup codes consumed)
- Login screen smoke

### Failing

1. Dashboard loads stub metrics when authenticated
2. Offline queue indicator exposes queued actions

### Likely Cause

- The E2E session route sets a `stub-auth` cookie, but it is invoked via
  Playwright's `request` client which does not share cookies with the browser
  context. As a result, the browser session visiting `/dashboard` is not
  authenticated and gets redirected/unauthenticated UI, causing assertions to
  fail.

### Suggested Fixes

- Option A (test harness): In Playwright, propagate the cookie to the browser
  context (e.g., capture `await request.storageState()` and
  `context.addCookies`, or use `storageState` between steps) so `/dashboard`
  renders with the stub session.
- Option B (app-side E2E shim): When `AUTH_E2E_STUB=1`, loosen `lib/auth.ts` to
  accept a header or query flag for test runs to treat requests as authenticated
  without the cookie, then add that flag in E2E navigation to `/dashboard`. This
  avoids cross-context cookie propagation but keeps behavior gated to E2E.

## Changes Made

- New E2E verification endpoints (non-production gated by `AUTH_E2E_STUB=1`):
  - `app/api/[e2e]/session/route.ts` (dynamic segment allows
    `/api/__e2e/session`)
  - `app/api/[e2e]/factors/verify/route.ts` (dynamic segment allows
    `/api/__e2e/factors/verify`)
- New dev smoke script: `scripts/dev-healthcheck.mjs`

These endpoints mirror the existing `app/api/__e2e/session` behavior and add an
MFA factor verification facade used by tests.

## Next Steps

- Confirm preferred path to fix the two E2E dashboard tests (Playwright cookie
  propagation vs. a gated app-side E2E switch).
- If desired, I can implement Option A or B and re-run E2E to reach full green.

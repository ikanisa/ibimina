
> @ibimina/admin@0.1.2 test:unit /home/runner/work/ibimina/ibimina/apps/admin
> tsx --test tests/unit/*.test.ts

TAP version 13
# Subtest: resolveTenantScope
    # Subtest: returns global scope for system admin without filter
    ok 1 - returns global scope for system admin without filter
      ---
      duration_ms: 1.102868
      ...
    # Subtest: respects explicit sacco filter for system admin
    ok 2 - respects explicit sacco filter for system admin
      ---
      duration_ms: 0.246357
      ...
    # Subtest: defaults to assigned sacco for tenant staff
    ok 3 - defaults to assigned sacco for tenant staff
      ---
      duration_ms: 0.214057
      ...
    # Subtest: ignores mismatched filters for tenant staff
    ok 4 - ignores mismatched filters for tenant staff
      ---
      duration_ms: 0.22647
      ...
    1..4
ok 1 - resolveTenantScope
  ---
  duration_ms: 3.319634
  type: 'suite'
  ...
# Subtest: resolveTenantScopeSearchParams
    # Subtest: returns undefined when input is falsy
    ok 1 - returns undefined when input is falsy
      ---
      duration_ms: 0.393822
      ...
    # Subtest: awaits promise-like inputs
    ok 2 - awaits promise-like inputs
      ---
      duration_ms: 1.13606
      ...
    # Subtest: normalizes URLSearchParams entries
    ok 3 - normalizes URLSearchParams entries
      ---
      duration_ms: 0.425981
      ...
    1..3
ok 2 - resolveTenantScopeSearchParams
  ---
  duration_ms: 2.370332
  type: 'suite'
  ...
# Subtest: audit export csv helpers
    # Subtest: renders empty strings for nullish values
    ok 1 - renders empty strings for nullish values
      ---
      duration_ms: 0.960183
      ...
    # Subtest: escapes embedded quotes and wraps records with separators
    ok 2 - escapes embedded quotes and wraps records with separators
      ---
      duration_ms: 0.2158
      ...
    # Subtest: produces attachment headers with csv content type
    ok 3 - produces attachment headers with csv content type
      ---
      duration_ms: 0.386999
      ...
    1..3
ok 3 - audit export csv helpers
  ---
  duration_ms: 2.903372
  type: 'suite'
  ...
# Subtest: audit logger
    # Subtest: writes structured audit entries with the authenticated actor
    ok 1 - writes structured audit entries with the authenticated actor
      ---
      duration_ms: 2.211518
      ...
    # Subtest: logs failures when Supabase rejects the insert
    ok 2 - logs failures when Supabase rejects the insert
      ---
      duration_ms: 0.591939
      ...
    1..2
ok 4 - audit logger
  ---
  duration_ms: 3.94179
  type: 'suite'
  ...
# consumeBackup: failed to read user Error: boom
#     at TestContext.<anonymous> (/home/runner/work/ibimina/ibimina/apps/admin/tests/unit/authx-backup.test.ts:93:20)
#     at Test.runInAsyncScope (node:async_hooks:206:9)
#     at Test.run (node:internal/test_runner/test:796:25)
#     at Suite.processPendingSubtests (node:internal/test_runner/test:526:18)
#     at Test.postRun (node:internal/test_runner/test:889:19)
#     at Test.run (node:internal/test_runner/test:835:12)
#     at async Promise.all (index 0)
#     at async Suite.run (node:internal/test_runner/test:1135:7)
#     at async Test.processPendingSubtests (node:internal/test_runner/test:526:7)
# Subtest: authx backup consumption
    # Subtest: consumes a valid backup code and persists remaining hashes
    ok 1 - consumes a valid backup code and persists remaining hashes
      ---
      duration_ms: 215.017995
      ...
    # Subtest: returns false when Supabase read fails
    ok 2 - returns false when Supabase read fails
      ---
      duration_ms: 3.292138
      ...
    # Subtest: returns false when the provided code does not match
    ok 3 - returns false when the provided code does not match
      ---
      duration_ms: 206.632725
      ...
    1..3
ok 5 - authx backup consumption
  ---
  duration_ms: 1032.758577
  type: 'suite'
  ...
# {"level":"info","event":"cache.revalidate.completed","timestamp":"2025-10-27T19:52:45.542Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"event":"payments_changed","saccoId":"11111111-1111-4111-8111-111111111111","tags":["dashboard:summary","analytics:executive:11111111-1111-4111-8111-111111111111","sacco:11111111-1111-4111-8111-111111111111"]}}
# Subtest: cache revalidate webhook
    # Subtest: returns 200 when tags revalidate successfully
    ok 1 - returns 200 when tags revalidate successfully
      ---
      duration_ms: 152.257436
      ...
# {"level":"error","event":"cache.revalidate.failed","timestamp":"2025-10-27T19:52:45.554Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"tag":"dashboard:summary","event":"recon_exceptions_changed","saccoId":null,"error":"boom"}}
# {"level":"info","event":"cache.revalidate.completed","timestamp":"2025-10-27T19:52:45.554Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"event":"recon_exceptions_changed","saccoId":null,"tags":["dashboard:summary","analytics:executive:all"]}}
    # Subtest: returns 207 when a tag revalidation throws
    ok 2 - returns 207 when a tag revalidation throws
      ---
      duration_ms: 7.840059
      ...
    1..2
ok 6 - cache revalidate webhook
  ---
  duration_ms: 161.615465
  type: 'suite'
  ...
# Subtest: submitJoinRequest
    # Subtest: should successfully submit a join request
    ok 1 - should successfully submit a join request
      ---
      duration_ms: 45.441244
      ...
    # Subtest: should throw error on failed join request
    ok 2 - should throw error on failed join request
      ---
      duration_ms: 4.281772
      ...
    # Subtest: should handle empty payload
    ok 3 - should handle empty payload
      ---
      duration_ms: 1.984788
      ...
    1..3
ok 7 - submitJoinRequest
  ---
  duration_ms: 52.950781
  type: 'suite'
  ...
# Subtest: fetchGroupMembers
    # Subtest: should successfully fetch members list
    ok 1 - should successfully fetch members list
      ---
      duration_ms: 4.468879
      ...
    # Subtest: should throw error for 401 Unauthorized
    ok 2 - should throw error for 401 Unauthorized
      ---
      duration_ms: 2.913821
      ...
    # Subtest: should throw error for 403 Forbidden
    ok 3 - should throw error for 403 Forbidden
      ---
      duration_ms: 2.717026
      ...
    # Subtest: should handle generic errors
    ok 4 - should handle generic errors
      ---
      duration_ms: 2.813014
      ...
    # Subtest: should handle non-JSON error responses
    ok 5 - should handle non-JSON error responses
      ---
      duration_ms: 1.609048
      ...
    1..5
ok 8 - fetchGroupMembers
  ---
  duration_ms: 15.338254
  type: 'suite'
  ...
# Subtest: resolveRequestLocale
    # Subtest: prefers the locale cookie when present
    ok 1 - prefers the locale cookie when present
      ---
      duration_ms: 19.680264
      ...
    # Subtest: falls back to accept-language ordering
    ok 2 - falls back to accept-language ordering
      ---
      duration_ms: 0.741317
      ...
    # Subtest: normalises region-specific language tags
    ok 3 - normalises region-specific language tags
      ---
      duration_ms: 0.319293
      ...
    # Subtest: returns the default locale when no hints are provided
    ok 4 - returns the default locale when no hints are provided
      ---
      duration_ms: 0.32331
      ...
    1..4
ok 9 - resolveRequestLocale
  ---
  duration_ms: 22.689583
  type: 'suite'
  ...
# {"level":"info","event":"queue_processed","timestamp":"2025-10-27T19:52:46.053Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"count":2}}
# Subtest: observability logger
    # Subtest: logs to console without forwarding when drain is not configured
    ok 1 - logs to console without forwarding when drain is not configured
      ---
      duration_ms: 6.9414
      ...
# {"level":"error","event":"drain_failure","timestamp":"2025-10-27T19:52:46.081Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"reason":"test"}}
    # Subtest: forwards structured payloads when log drain is configured
    ok 2 - forwards structured payloads when log drain is configured
      ---
      duration_ms: 27.02712
      ...
    # Subtest: propagates contextual fields into log entries
    ok 3 - propagates contextual fields into log entries
      ---
      duration_ms: 1.096045
      ...
    # Subtest: never throws when forwarding fails
    ok 4 - never throws when forwarding fails
      ---
      duration_ms: 4.771481
      ...
    1..4
ok 10 - observability logger
  ---
  duration_ms: 41.195411
  type: 'suite'
  ...
# Subtest: mfa crypto helpers
    # Subtest: encrypts and decrypts sensitive payloads
    ok 1 - encrypts and decrypts sensitive payloads
      ---
      duration_ms: 2.833662
      ...
    # Subtest: generates backup codes that can be consumed once
    ok 2 - generates backup codes that can be consumed once
      ---
      duration_ms: 369.367177
      ...
    # Subtest: verifies the current TOTP code for a generated secret
    ok 3 - verifies the current TOTP code for a generated secret
      ---
      duration_ms: 2.078961
      ...
    1..3
ok 11 - mfa crypto helpers
  ---
  duration_ms: 375.700367
  type: 'suite'
  ...
# Subtest: mfa factor facade
    # Subtest: delegates to the totp adapter
    ok 1 - delegates to the totp adapter
      ---
      duration_ms: 1.667606
      ...
    # Subtest: returns downstream failures without modification
    ok 2 - returns downstream failures without modification
      ---
      duration_ms: 0.364837
      ...
    # Subtest: delegates email verification to the adapter
    ok 3 - delegates email verification to the adapter
      ---
      duration_ms: 0.459914
      ...
    # Subtest: rejects unsupported factors
    ok 4 - rejects unsupported factors
      ---
      duration_ms: 0.311148
      ...
    # Subtest: routes email initiation to the adapter
    ok 5 - routes email initiation to the adapter
      ---
      duration_ms: 0.652341
      ...
    # Subtest: delegates passkey initiation to the AuthX challenge helper
    ok 6 - delegates passkey initiation to the AuthX challenge helper
      ---
      duration_ms: 1.129748
      ...
    # Subtest: invokes passkey verification when requested
    ok 7 - invokes passkey verification when requested
      ---
      duration_ms: 0.543059
      ...
    # Subtest: invokes whatsapp initiation
    ok 8 - invokes whatsapp initiation
      ---
      duration_ms: 0.450206
      ...
    1..8
ok 12 - mfa factor facade
  ---
  duration_ms: 7.277554
  type: 'suite'
  ...
# Subtest: notification dispatch helpers
    # Subtest: computes retry delays with exponential backoff
    ok 1 - computes retry delays with exponential backoff
      ---
      duration_ms: 1.137723
      ...
    # Subtest: retries WhatsApp jobs when rate limit denies
    ok 2 - retries WhatsApp jobs when rate limit denies
      ---
      duration_ms: 1.460573
      ...
    # Subtest: delivers WhatsApp jobs when Twilio succeeds
    ok 3 - delivers WhatsApp jobs when Twilio succeeds
      ---
      duration_ms: 0.642332
      ...
    # Subtest: fails email jobs without recipient
    ok 4 - fails email jobs without recipient
      ---
      duration_ms: 0.830412
      ...
    # Subtest: retries email jobs on upstream errors
    ok 5 - retries email jobs on upstream errors
      ---
      duration_ms: 0.471505
      ...
    1..5
ok 13 - notification dispatch helpers
  ---
  duration_ms: 6.267499
  type: 'suite'
  ...
# {"level":"info","event":"rate_limit_blocked","timestamp":"2025-10-27T19:52:47.392Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"key":"12001d690769fa48f6697c9d71f7268ac880ffd04340880079c3065d3e6fc8f9","maxHits":1,"windowSeconds":60}}
# {"level":"error","event":"rate_limit_rpc_failed","timestamp":"2025-10-27T19:52:47.395Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"key":"4b8642a8f86a6eca14762ef41d6116ea368584a65c47ccb43cd92eadecec9e4e","error":{"name":"Error","message":"db down","stack":"Error: db down\\n    at Object.rpc (/home/runner/work/ibimina/ibimina/apps/admin/tests/unit/rate-limit.test.ts:74:76)\\n    at enforceRateLimit (/home/runner/work/ibimina/ibimina/apps/admin/lib/rate-limit.ts:39:51)\\n    at async applyRateLimit (/home/runner/work/ibimina/ibimina/apps/admin/src/auth/limits.ts:34:5)\\n    at async TestContext.<anonymous> (/home/runner/work/ibimina/ibimina/apps/admin/tests/unit/rate-limit.test.ts:76:19)\\n    at async Test.run (node:internal/test_runner/test:797:9)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)"},"maxHits":1,"windowSeconds":1}}
# {"level":"error","event":"rate_limit_rpc_failed","timestamp":"2025-10-27T19:52:47.398Z","requestId":null,"userId":null,"saccoId":null,"source":null,"environment":"development","payload":{"key":"4b8642a8f86a6eca14762ef41d6116ea368584a65c47ccb43cd92eadecec9e4e","error":{"name":"Error","message":"db down","stack":"Error: db down\\n    at Object.rpc (/home/runner/work/ibimina/ibimina/apps/admin/tests/unit/rate-limit.test.ts:74:76)\\n    at enforceRateLimit (/home/runner/work/ibimina/ibimina/apps/admin/lib/rate-limit.ts:39:51)\\n    at async applyRateLimit (/home/runner/work/ibimina/ibimina/apps/admin/src/auth/limits.ts:34:5)\\n    at async TestContext.<anonymous> (/home/runner/work/ibimina/ibimina/apps/admin/tests/unit/rate-limit.test.ts:79:20)\\n    at async Test.run (node:internal/test_runner/test:797:9)\\n    at async Suite.processPendingSubtests (node:internal/test_runner/test:526:7)"},"maxHits":1,"windowSeconds":1}}
# Subtest: rate limit helpers
    # Subtest: allows requests when Supabase RPC approves
    ok 1 - allows requests when Supabase RPC approves
      ---
      duration_ms: 2.425344
      ...
    # Subtest: blocks requests when Supabase RPC rejects
    ok 2 - blocks requests when Supabase RPC rejects
      ---
      duration_ms: 2.884417
      ...
    # Subtest: falls back to in-memory enforcement when Supabase RPC fails
    ok 3 - falls back to in-memory enforcement when Supabase RPC fails
      ---
      duration_ms: 4.241617
      ...
    # Subtest: prevents TOTP replay within the same window
    ok 4 - prevents TOTP replay within the same window
      ---
      duration_ms: 0.884382
      ...
    1..4
ok 14 - rate limit helpers
  ---
  duration_ms: 268.585662
  type: 'suite'
  ...
# Subtest: security header helpers
    # Subtest: produces a base64 nonce using getRandomValues
    ok 1 - produces a base64 nonce using getRandomValues
      ---
      duration_ms: 1.95486
      ...
    # Subtest: falls back to randomUUID when getRandomValues is unavailable
    ok 2 - falls back to randomUUID when getRandomValues is unavailable
      ---
      duration_ms: 0.552656
      ...
    # Subtest: falls back to runtime crypto when Web Crypto APIs are missing
    ok 3 - falls back to runtime crypto when Web Crypto APIs are missing
      ---
      duration_ms: 1.391124
      ...
    # Subtest: generates request IDs via randomUUID when available
    ok 4 - generates request IDs via randomUUID when available
      ---
      duration_ms: 0.621745
      ...
    # Subtest: derives hex request IDs from getRandomValues when randomUUID is absent
    ok 5 - derives hex request IDs from getRandomValues when randomUUID is absent
      ---
      duration_ms: 0.5816
      ...
    # Subtest: falls back to runtime crypto for request IDs without Web Crypto
    ok 6 - falls back to runtime crypto for request IDs without Web Crypto
      ---
      duration_ms: 0.708986
      ...
    1..6
ok 15 - security header helpers
  ---
  duration_ms: 7.494017
  type: 'suite'
  ...
# Subtest: supabase config helpers
    # Subtest: returns config when env vars are present
    ok 1 - returns config when env vars are present
      ---
      duration_ms: 10.88882
      ...
    # Subtest: throws a descriptive error when config is missing
    ok 2 - throws a descriptive error when config is missing
      ---
      duration_ms: 4.230496
      ...
    1..2
ok 16 - supabase config helpers
  ---
  duration_ms: 16.40775
  type: 'suite'
  ...
# Subtest: isMissingRelationError
    # Subtest: returns false for nullish values
    ok 1 - returns false for nullish values
      ---
      duration_ms: 0.74289
      ...
    # Subtest: matches postgres relation missing code
    ok 2 - matches postgres relation missing code
      ---
      duration_ms: 0.165217
      ...
    # Subtest: matches textual relation missing hints
    ok 3 - matches textual relation missing hints
      ---
      duration_ms: 0.981282
      ...
    # Subtest: returns false for other errors
    ok 4 - returns false for other errors
      ---
      duration_ms: 0.201414
      ...
    1..4
ok 17 - isMissingRelationError
  ---
  duration_ms: 3.050615
  type: 'suite'
  ...
1..17
# tests 65
# suites 17
# pass 65
# fail 0
# cancelled 0
# skipped 0
# todo 0
# duration_ms 3687.823758
